---
title: "ENIGH Data Analysis"
author: "Mauricio Hernandez"
date: "2/22/2021"
subtitle: Household's Energy Related Expenses 
output:
  html_document:
    df_print: paged
---

```{r, include=FALSE}
#Remove all objects from current workspace and call garbage collector
rm(list=ls())
gc()

#Set WD
current_path = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))
```

```{r sh, include=FALSE}
source("./scripts/setup_functions.R")
```

```{r knitr_init, include=FALSE}
#options(max.print = "75")
opts_chunk$set(echo = TRUE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE,
               fig.path = 'figs/')
```

```{r, include=FALSE}
#Generates the css needed by summarytools
st_css()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = TRUE)

knitr::knit_hooks$set(output = function(x, options){
  if(!is.null(options$max_height)){
    paste('<pre style = "max-height:',
          options$max_height, 
          ';float: left; width: 910px; overflow-y: auto;">',
          x,
          "</pre>",
          sep = "")
  } else{
    x
  }
})


#Set WD
current_path = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))
print( getwd() )

#Load Packages
if (!require("pacman")) install.packages("pacman")
  pacman::p_load(pacman, party, psych, rio, tidyverse, knitr, bit64, plotly, 
                 forcats, stargazer, summarytools)

opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```


## Reading ENIGH microdata (CSV files)
```{r include = TRUE, echo = FALSE,  results='hide'}
path_data <- "https://mauricioh2.com/disreu/inegi/enigh/"

df_dwell <-read_csv(paste0(path.data, "2018_enigh_viviendas.csv"), col_names = TRUE,
                   col_types=c("folioviv"="c", "estufa_chi"= 'i', 'mat_techos' ='i', 
                               'num_dueno1' ='i', 'num_dueno2' ='i'), na ='&')

df_hsd_energy <-read_csv('./outputs/2018_enigh_hsd_energy_exp.csv', 
                         col_names = TRUE, progress = TRUE, na ='NULL',
                         col_types=cols_only("folioviv"='c', "foliohog"='c', 
                                             "clave"='c',
                                             "tipo_gasto"='c', "mes_dia"='c', 
                                             "forma_pag1"='i', "forma_pag2"='i', 
                                             "forma_pag3"='i', "lugar_comp"='i',
                                             "orga_inst"='i', "frecuencia"='i', 
                                             "fecha_adqu"='c', "fecha_pago"='c', 
                                             "cantidad"='d', "gasto"='d',
                                             "pago_mp"='d', "costo"='d', 
                                             "inmujer"='d',"inst_1"='i', 
                                             "inst_2"='i', "num_meses"='i',
                                             "num_pagos"='i', "ultim_pago"='c', 
                                             "gasto_tri"='d',"gasto_nm"='d', 
                                             "gas_nm_tri"='d', "imujer_tri"='d'),)
```


```{r include = TRUE, echo = FALSE,  results='hide'}
df_person_energy <-read_csv('./outputs/2018_enigh_psn_energy_exp.csv',col_names = TRUE,
                   col_types=c("folioviv"="c", 'inst' ='i', 'colegia' = 'd', 
                               'material' = 'd', 'inscrip' = 'd', 'gasto_tri'= 'd'), 
                   na ='NULL',)
```
## Check Energy Expenses

Check all the energy expenses in the households expenses data set and people expenses data sets are the same than the ones reported in the households condensed data set.

df_hsd_condens$energia is equal to the sum of gastoshogar.gasto_tri if clave is equal to G009-G016, R001, R003 plus 
gastospersona.gasto_tri if clave is equal to G009-G016, R001, R003.


|Code (clave) |    Description         |
| ----------- |:----------------------:|
|G009    	    |Liquefied petroleum gas |
|G010    	    |Petroleum               |
|G011    	    |Diesel                  |
|G012    	    |Carbon                  |
|G013    	    |Firewood                |
|G014    	    |Fuel to heat            |
|G015    	    |Candles                 |
|G016    	    |Other fuels             |
|R001    	    |Electricity             |
|R003    	    |Natural Gas			       |


```{r}
#df_person_energy
# Create household id, this will be the key attribute in the SQL table
df_hsd_energy$id_household <- paste0(df_hsd_energy$folioviv, df_hsd_energy$foliohog)
df_person_energy$id_household <- paste0(df_person_energy$folioviv, df_person_energy$foliohog)
```



Merging data sets by id_household using energy expenses related data
```{r}
df_hsd_energy_by_hsd <- df_hsd_energy %>%
  group_by(id_household, clave) %>% replace(is.na(.), 0) %>% 
  summarise(gasto_tri = sum(gasto_tri))

df_psn_energy_by_hsd <- df_person_energy %>%
  group_by(id_household, clave) %>% replace(is.na(.), 0) %>% 
  summarise(gasto_tri = sum(gasto_tri))
```
```{r}
df_energy_by_hsd <- merge(df_hsd_energy_by_hsd, df_psn_energy_by_hsd, 
                          by="id_household", all.y = TRUE, all.x = TRUE) %>% 
  replace(is.na(.), 0)

```


```{r}
df_hsd_energy_by_hsd <- as.data.frame(df_hsd_energy_by_hsd)
df_hsd_energy_by_hsd
```

```{r}
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G009'] <- 'LPG'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G010'] <- 'Petroleum'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G011'] <- 'Diesel'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G012'] <- 'Carbon'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G013'] <- 'Firewood'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G014'] <- 'Fuel_to_heat'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G015'] <- 'Candles'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='G016'] <- 'Other'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='R001'] <- 'Electricity'
df_hsd_energy_by_hsd$clave[df_hsd_energy_by_hsd$clave=='R003'] <- 'NG'
```

```{r}
#df_hsd_energy_by_hsd$clave <-as.factor(df_hsd_energy_by_hsd$clave)
df_hsd_by_hsd_wd <- reshape(df_hsd_energy_by_hsd, v.names = 'gasto_tri',
                            timevar='clave', idvar="id_household", sep = "_",
                            direction="wide")

df_hsd_by_hsd_wd
```

## Descriptive Statistics
```{r}
descr(df_hsd_by_hsd_wd, stats = c("mean", "sd", "min", "med", "max", "n.valid", "pct.valid"), 
      transpose = TRUE)
```

### Box Plots
```{r plt-num-bulbs-box, fig.cap="Boxplots of energy expenses per household", results="hold"}
pal_plot <- c('grey','red', 'rgb(7,40,89)', 'green')
pal_plot <- setNames(pal_plot, c("elect", "ng", "candles", "lpg"))

#df_hsd_by_hsd_wd[is.na(df_hsd_by_hsd_wd)] = 0

pl_energy_exp_box <- plot_ly(type = 'box') %>%
  add_boxplot(y = df_hsd_by_hsd_wd$gasto_tri_Electricity, 
              boxpoints = 'outliers', 
              name = "Electricity", 
              color = list(color =pal_plot['elect']),
              marker = list(color = pal_plot['elect']), 
              line=list(color = pal_plot['elect']) ) %>%
  add_boxplot(y = df_hsd_by_hsd_wd$gasto_tri_NG, 
              boxpoints = 'outliers', 
              name = "Natural Gas", 
              color = list(color =pal_plot['ng']),
              marker = list(color = pal_plot['ng']), 
              line=list(color = pal_plot['ng']) ) %>%
  add_boxplot(y = df_hsd_by_hsd_wd$gasto_tri_Candles, 
              boxpoints = 'outliers', 
              name = "Candles", 
              color = list(color =pal_plot['candles']),
              marker = list(color = pal_plot['candles']), 
              line=list(color = pal_plot['candles']) ) %>%
  add_boxplot(y = df_hsd_by_hsd_wd$gasto_tri_LPG, 
              boxpoints = 'outliers', 
              name = "LPG", 
              color = list(color =pal_plot['lpg']),
              marker = list(color = pal_plot['lpg']), 
              line=list(color = pal_plot['lpg']) ) %>%
  layout(title = "Boxplots of Expenses by Household per Type of Energy", 
         yaxis = list(title = "$[MXN]", range = c(0, 5000)))

pl_energy_exp_box

plotly_IMAGE(pl_energy_exp_box, format = "png", out_file = "./figs/box_energy_expenses.png" )

```
# Analysis of Expenses by Dwelling

Adding factor

```{r}
df_hshd$id_household <- paste0(df_hshd$folioviv, df_hshd$foliohog)

df_hshd <- subset(df_hshd, select=c('id_household', 'factor'))

df_hsd_by_hsd_wd <- merge(df_hsd_by_hsd_wd, df_hshd, 
                          by="id_household", all.y = TRUE, all.x = TRUE)
```


